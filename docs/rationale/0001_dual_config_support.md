# 0001: Dual Config Support (Melos 6.x + 7.x)

## Context

Melos is the standard monorepo management tool for Flutter/Dart projects.
Between versions 6.x and 7.x, Melos made a significant architectural shift
in how workspaces are configured and how local packages are linked.

melos-rs aims to support both the legacy format (melos.yaml, Melos 3.x-6.x)
and the modern format (pubspec.yaml with `melos:` key, Melos 7.x).

## What Changed in Melos 7.x

| Aspect | Melos 3.x-6.x | Melos 7.x |
|---|---|---|
| Config file | `melos.yaml` | Root `pubspec.yaml` under `melos:` key |
| Package globs | `packages:` in melos.yaml | `workspace:` in pubspec.yaml |
| Local linking | `pubspec_overrides.yaml` generated per-package | Dart Pub Workspaces (`resolution: workspace`) |
| Package pubspecs | No special field needed | Must add `resolution: workspace` |
| Melos dependency | Optional global install | Required as `dev_dependency` in root pubspec |
| `melos.yaml` | Required | Does not exist |

### Pub Workspaces (Dart 3.6+)

Dart 3.6 introduced native workspace support. The root `pubspec.yaml` declares
a `workspace:` field listing all package paths. Each package declares
`resolution: workspace`. When `dart pub get` runs, the resolver automatically
links workspace packages via relative paths in `.dart_tool/package_config.json`.

This eliminates the need for Melos to generate `pubspec_overrides.yaml` files.

### pubspec_overrides.yaml (Melos 3.x-6.x)

In the legacy approach, `melos bootstrap` generates a `pubspec_overrides.yaml`
in each package that depends on other workspace packages:

```yaml
# packages/app/pubspec_overrides.yaml (auto-generated by melos)
dependency_overrides:
  core:
    path: ../core
  utils:
    path: ../utils
```

These files should be `.gitignore`d. They allow `pub get` to resolve sibling
packages via local paths without modifying the actual `pubspec.yaml`.

## Our Approach

### Config Detection (Automatic)

1. Walk up from cwd looking for `melos.yaml` -- if found, use **6.x mode**
2. If no `melos.yaml`, look for `pubspec.yaml` containing a `melos:` key -- use **7.x mode**
3. If neither found, bail with an actionable error message

This means existing 6.x projects work without changes, and new 7.x projects
are also supported.

### Bootstrap Behavior

| Mode | Bootstrap action |
|---|---|
| 6.x | Generate `pubspec_overrides.yaml` per-package, then run `pub get` |
| 7.x | Just run `pub get` (Pub Workspaces handles linking) |

### Clean Behavior

| Mode | Clean action |
|---|---|
| 6.x | Remove `pubspec_overrides.yaml` files (in addition to build artifacts) |
| 7.x | No override files to clean |

### Init Command (New, 7.x only)

`melos-rs init` will scaffold a new workspace in the 7.x style:

- Create root `pubspec.yaml` with `workspace:` and `melos:` sections
- Add `resolution: workspace` to discovered package pubspecs

## Implementation Touch Points

### `workspace.rs`

- `find_config_file()` becomes `find_config()` returning a `ConfigSource` enum
- `ConfigSource::MelosYaml(PathBuf)` vs `ConfigSource::PubspecYaml(PathBuf)`
- `Workspace` gains a `config_source: ConfigSource` field for downstream decisions

### `config/mod.rs`

- `parse_config()` branches on `ConfigSource`
- For 7.x: deserialize a wrapper struct, extract `melos:` sub-key
- `packages` field: in 7.x, read from `workspace:` in pubspec if not in `melos:`
- `name` field: in 7.x, can default from pubspec top-level `name`

### `commands/bootstrap.rs`

- Check `workspace.config_source` to decide whether to generate `pubspec_overrides.yaml`

### `commands/clean.rs`

- In 6.x mode, also remove `pubspec_overrides.yaml` from each package

## Precedence and Edge Cases

- If both `melos.yaml` and `pubspec.yaml` with `melos:` exist, prefer `melos.yaml`
  (the user hasn't migrated yet)
- `packages` globs from `melos.yaml` and `workspace:` paths from pubspec are
  semantically different (globs vs explicit paths) -- normalize both to globs
  for `discover_packages()`
- Dart SDK >=3.6 is required for 7.x mode; we don't enforce this but document it

## References

- [Melos 6.x to 7.x Migration Guide](https://melos.invertase.dev/~melos-latest/guides/migrations)
- [Dart Pub Workspaces](https://dart.dev/tools/pub/workspaces)
- [Melos Bootstrap Docs](https://melos.invertase.dev/~melos-latest/commands/bootstrap)
